---
title: Azure AD Connect：将组从一个林迁移到另一个林 | Microsoft Docs
description: 本文介绍了为 Azure AD Connect 将组从一个林成功迁移到另一个林需要执行的步骤。
services: active-directory
author: billmath
manager: daveba
ms.service: active-directory
ms.topic: reference
ms.workload: identity
ms.date: 04/21/2020
ms.subservice: hybrid
ms.author: v-junlch
ms.collection: M365-identity-device-management
ms.openlocfilehash: 48c3eb9854e2a88f00ecda4baf3d79571798f965
ms.sourcegitcommit: a4a2521da9b29714aa6b511fc6ba48279b5777c8
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/24/2020
ms.locfileid: "82127198"
---
# <a name="migrate-groups-from-one-forest-to-another-for-azure-ad-connect"></a>为 Azure AD Connect 将组从一个林迁移到另一个林

本文介绍了需要执行哪些步骤才能将组从一个林成功迁移到另一个林，使迁移的组对象与云中的现有对象匹配。

## <a name="prerequisites"></a>先决条件

- Azure AD Connect 1.5.18.0 或更高版本
- 源定位点属性是 `mS-DS-ConsistencyGuid`

从版本 1.5.18.0 开始，Azure AD Connect 已开始支持使用组的 `mS-DS-ConsistencyGuid`。 如果选择 `mS-DS-ConsistencyGuid` 作为源定位点属性，并且在 AD 中填充该值，则 Azure AD Connect 将使用 `mS-DS-ConsistencyGuid` 的值作为 immutableId。 否则，它将回退为使用 `objectGUID`。 但请注意，Azure AD Connect 不会  将值写回到 AD 中的 `mS-DS-ConsistencyGuid` 属性。

在将组对象从一个林（如 F1）移到另一个林（如 F2）的跨林移动方案中，我们需要将林 F1 中对象的 `mS-DS-ConsistencyGuid` 值（如果存在）或 `objectGUID` 值复制到 F2 中对象的 `mS-DS-ConsistencyGuid` 属性。 

请使用以下脚本作为指导，了解如何将单个组从林 F1 迁移到林 F2。 为多个组执行迁移时，也可以使用此脚本作为指导。

首先，我们获取林 F1 中组对象的 `objectGUID` 和 `mS-DS-ConsistencyGuid`。 这些属性将导出到 CSV 文件中。
```
<#
DESCRIPTION
============
This script will take DN of a group as input.
It then copies the objectGUID and mS-DS-ConsistencyGuid values along with other attributes of the given group to a CSV file.

This CSV file can then be used as input to Export-Group script
#>
Param(
       [ValidateNotNullOrEmpty()]
       [string]
       $dn,

       [ValidateNotNullOrEmpty()]
       [string]
       $outputCsv
)

$defaultProperties = @('samAccountName', 'distinguishedName', 'objectGUID', 'mS-DS-ConsistencyGuid')
$group  = Get-ADGroup -Filter "DistinguishedName -eq '$dn'" -Properties $defaultProperties -ErrorAction Stop
$results = @()
if ($group -eq $null)
{
       Write-Error "Group not found"
}
else
{
       $objectGUIDValue = [GUID]$group.'objectGUID'
       $mSDSConsistencyGuidValue = "N/A"
       if ($group.'mS-DS-ConsistencyGuid' -ne $null)
       {
              $mSDSConsistencyGuidValue = [GUID]$group.'mS-DS-ConsistencyGuid'
       }
       $adgroup = New-Object -TypeName PSObject
       $adgroup | Add-Member -MemberType NoteProperty -Name samAccountName -Value $($group.'samAccountName')
       $adgroup | Add-Member -MemberType NoteProperty -Name distinguishedName -Value $($group.'distinguishedName')
       $adgroup | Add-Member -MemberType NoteProperty -Name objectGUID -Value $($objectGUIDValue)
       $adgroup | Add-Member -MemberType NoteProperty -Name mS-DS-ConsistencyGuid -Value $($mSDSConsistencyGuidValue)
       $results += $adgroup
}

Write-Host "Exporting group to output file"
$results | Export-Csv "$outputCsv" -NoTypeInformation

```

接下来，我们使用生成的输出 CSV 文件来标记林 F2 中目标对象的 `mS-DS-ConsistencyGuid` 属性。


```
<#
DESCRIPTION
============
This script will take DN of a group as input and the CSV file that was generated by Import-Group script
It copies either the objectGUID or mS-DS-ConsistencyGuid value from CSV file to the given object.

#>
Param(
       [ValidateNotNullOrEmpty()]
       [string]
       $dn,

       [ValidateNotNullOrEmpty()]
       [string]
       $inputCsv
)

$group  = Get-ADGroup -Filter "DistinguishedName -eq '$dn'" -ErrorAction Stop
if ($group -eq $null)
{
       Write-Error "Group not found"
}

$csvFile = Import-Csv -Path $inputCsv -ErrorAction Stop
$msDSConsistencyGuid = [GUID] $csvFile.'mS-DS-ConsistencyGuid'
$objectGuid = [GUID] $csvFile.'objectGUID'
$targetGuid = $msDSConsistencyGuid

if ($msDSConsistencyGuid -eq "N/A")
{
       $targetGuid = $objectGuid
}

Set-ADGroup -Identity $dn -Replace @{'mS-DS-ConsistencyGuid'=$targetGuid} -ErrorAction Stop

```

## <a name="next-steps"></a>后续步骤
了解有关[将本地标识与 Azure Active Directory 集成](whatis-hybrid-identity.md)的详细信息。

