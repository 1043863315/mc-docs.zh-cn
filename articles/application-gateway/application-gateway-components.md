---
title: Azure 应用程序网关组件
description: 本文提供有关应用程序网关中各个组件的信息
services: application-gateway
author: abshamsft
ms.service: application-gateway
ms.topic: article
origin.date: 02/20/2019
ms.date: 02/26/2019
ms.author: v-junlch
ms.openlocfilehash: c326bc017e216d46c9af1c5607572f0bc1ce6ba2
ms.sourcegitcommit: e9f088bee395a86c285993a3c6915749357c2548
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/26/2019
ms.locfileid: "56837024"
---
# <a name="application-gateway-components"></a>应用程序网关组件

 应用程序网关充当客户端的单一联络点。 它在 Azure VM、VMSS、应用服务或本地/外部服务器等多个后端池之间分配传入的应用程序流量。 为此，它会利用如下所述的多个组件：

![application-gateway-components](./media/application-gateway-components/application-gateway-components.png)

## <a name="frontend-ip"></a>前端 IP

前端 IP 是与应用程序网关关联的 IP（Internet 协议）地址。 可将应用程序网关配置为使用公共 IP 和/或专用 IP。 应用程序网关仅支持一个公共 IP 地址。 虚拟网络和公共 IP 地址必须位于应用程序网关所在的同一位置。

### <a name="static-vs-dynamic-public-ip"></a>静态与动态公共 IP

v1 SKU 支持静态内部 IP，但不支持静态公共 IP。 如果停止再启动应用程序网关，则 VIP 可能会变化。 与应用程序网关关联的 DNS 名称在网关的整个生命周期内不会变化。 出于此原因，建议使用 CNAME 别名并使其指向应用程序网关的 DNS 地址。

创建一个前端 IP 后，该 IP 将关联到检查前端 IP 上的传入请求的侦听器。

## <a name="listeners"></a>侦听器

在开始使用应用程序网关之前，必须添加一个或多个侦听器。 侦听器是一个进程，应用程序网关使用该进程通过你配置的协议和端口检查传入的连接请求。 侦听器检测到来自客户端的传入请求后，应用程序网关会使用你为收到传入请求的侦听器所定义的请求路由规则，将这些请求路由到后端池中的后端服务器。

侦听器支持以下端口和协议：

### <a name="ports"></a>端口

侦听器在此端口上侦听客户端请求。 端口配置允许以下范围：1-65535

### <a name="protocols"></a>协议

应用程序网关支持以下 4 种协议：HTTP、HTTPS、HTTP/2、Websocket

配置侦听器时，需要在 HTTP 与 HTTPS 协议之间进行选择。 应用程序网关原生支持 WebSocket 和 HTTP/2 协议。 可对 HTTP 和 HTTPS 侦听器使用 WebSocket。 

仅针对连接到应用程序网关侦听程序的客户端提供了 HTTP/2 协议支持。 与后端服务器池的通信是通过 HTTP/1.1 进行的。 默认情况下，HTTP/2 支持处于禁用状态。 以下 Azure PowerShell 代码片段示例展示了如何启用该支持：

```azurepowershell
$gw = Get-AzureRmApplicationGateway -Name test -ResourceGroupName hm

$gw.EnableHttp2 = $true

Set-AzureRmApplicationGateway -ApplicationGateway $gw
```

默认已启用 WebSocket 支持。 用户无法通过配置设置来选择性地启用或禁用 WebSocket 支持。

可以使用 HTTPS 侦听器进行 SSL 终止，这会将加密和解密工作卸载到应用程序网关，以缓解较大的加密和解密开销给 Web 服务器造成的负担，同时，可让应用程序专注于其业务逻辑。 对于每个 HTTPS 侦听器，必须至少部署一个 SSL 服务器证书。 有关详细信息，请参阅[如何配置 SSL 终止](/application-gateway/create-ssl-portal)。

### <a name="custom-error-pages"></a>自定义错误页

应用程序网关允许你创建自定义错误页而非显示默认错误页。 你可以在自定义错误页上使用自己的品牌和布局。 当请求无法到达后端时，应用程序网关可以显示自定义错误页。 有关详细信息，请参阅[应用程序网关的自定义错误页](/application-gateway/custom-error)

### <a name="types-of-listeners"></a>侦听器类型

有两种类型的侦听器：

- **基本**：此类侦听器侦听单个域站点，该站点中的单个 DNS 映射到应用程序网关的 IP 地址。 在应用程序网关后面托管单个站点时，需要使用此侦听器配置
- **多站点**：在同一个应用程序网关实例上配置多个 Web 应用程序时，需要使用此侦听器配置。 这样可以将最多 100 个网站添加到一个应用程序网关，为部署配置更有效的拓扑。 每个网站都可以定向到自己的后端池。 例如：针对三个指向应用程序网关 IP 地址的子域 — abc.alpha.com、xyz.alpha.com 和 pqr.alpha.com， 可以创建 3 个“多站点”类型的侦听器，并为每个侦听器配置相应的端口和协议设置。 

创建侦听器后，将它与某个请求路由规则相关联。该规则确定如何将侦听器上收到的请求路由到后端。

按侦听器的显示顺序进行处理。 因此，如果基本侦听器与传入请求匹配，它会先处理该请求。 应将多站点侦听器配置在基本侦听器之前，以确保将流量路由到正确的后端。

## <a name="request-routing-rule"></a>请求路由规则

这是最重要的应用程序网关组件，它确定如何路由与此规则关联的侦听器上的流量。 该规则绑定侦听器、后端服务器池和后端 HTTP 设置，并定义当流量抵达特定侦听器时应定向到的后端服务器池。 一个侦听器只能附加到一个规则。

可以使用两种类型的请求路由规则：

- **基本：** 使用关联的 HTTP 设置将关联的侦听器（例如 blog.contoso.com/*）上的所有请求转发到关联的后端池。
- **基于路径：** 此类规则可让你根据请求中的 URL，将关联的侦听器上的请求路由到特定的后端池。 如果请求中的 URL 路径与基于路径的规则中的路径模式相匹配，则使用该规则路由请求。 路径模式仅应用到 URL 的路径，而不应用到该 URL 的查询参数。 

如果侦听器上的请求 URL 路径与任何基于路径的规则都不匹配，则将请求路由到默认的后端池和默认的 HTTP 设置。

按配置规则的顺序处理规则。 建议将多站点规则配置在基本规则之前，以降低将流量路由到错误后端的可能性，因为基本规则会在评估多站点规则之前根据端口匹配流量。

### <a name="redirection-support"></a>重定向支持

请求路由规则还允许重定向应用程序网关上的流量。 这是一种通用重定向机制，因此可以针对使用规则定义的任何端口进行双向重定向。 这可以帮助你启用 HTTP 到 HTTPS 的自动重定向，以确保应用程序与用户之间的所有通信通过加密的路径进行。 可以指定需要重定向到的目标侦听器或外部站点。 配置元素还支持一些选项，通过这些选项可以将 URI 路径和查询字符串追加到重定向的 URL。 你还可以选择重定向是临时重定向（HTTP 状态代码 302）还是永久重定向（HTTP 状态代码 301）。 使用基本规则时，重定向配置与源侦听器相关联，并且是全局重定向。 使用基于路径的规则时，将在 URL 路径映射中定义重定向配置。 因此，它仅适用于站点的特定路径区域。 有关详细信息，请参阅[重定向应用程序网关上的流量](/application-gateway/redirect-overview)。

## <a name="http-settings"></a>HTTP 设置

应用程序网关使用此资源中指定的端口号、协议和其他设置将流量路由到后端服务器。 

后端池支持以下端口和协议：

### <a name="ports"></a>端口

后端服务器在此端口上侦听来自应用程序网关的流量。 端口配置允许以下范围：1-65535

### <a name="protocols"></a>协议

应用程序网关支持使用 HTTP 和 HTTPS 协议将请求路由到后端服务器。

如果选择了 HTTP 协议，则流量将以未加密的状态传送到后端服务器。 

如果无法接受与后端服务器之间进行未加密的通信，则应选择 HTTPS 协议。 如果使用此设置并在侦听器中选择 HTTPS 协议，则可以实现[端到端的 SSL](/application-gateway/ssl-overview)。 这样，就可以安全地将敏感数据以加密的形式传输到后端。 后端池中每个已启用端到端 SSL 的后端服务器都必须配置证书，以便能够进行安全的通信。

使用 HTTP 设置可以利用多种功能：

### <a name="cookie-based-session-affinity"></a>基于 Cookie 的会话关联

需要在同一台服务器上保留用户会话时，此功能非常有用。 借助网关托管的 Cookie，应用程序网关可以将来自用户会话的后续流量定向到同一服务器进行处理。 在用户会话的会话状态在服务器上进行本地保存的情况下，此功能十分重要。

如果应用程序无法处理基于 Cookie 的相关性，则你无法使用此功能

### <a name="connection-draining"></a>连接清空

连接清空可帮助你在计划内服务更新期间正常删除后端池成员。 在创建规则期间，可将此设置应用到后端池的所有成员。 启用后，应用程序网关可确保后端池的所有已取消注册实例不再收到任何新请求，同时允许现有请求在所配置的时间限制内完成。 这适用于通过 API 调用显式从后端池中删除的后端实例，以及所报告的由运行状况探测确定为不正常的后端实例。

### <a name="override-backend-path"></a>替代后端路径

使用此功能可以替代 URL 中的路径，以便可将特定路径的请求路由到另一个路径。 例如，如果你想要将 contoso.com/images 的请求路由到默认位置，请在此文本框中输入“/”，随后将此 HTTP 设置附加到与 contoso.com/images 关联的规则。

### <a name="pick-host-name-from-a-backend-address"></a>从后端地址中选取主机名

此功能将请求中的 *host* 标头设置为后端池的主机名（IP 或 FQDN）。 如果后端的域名不同于应用程序的 DNS 名称（例如，将 Azure 应用服务用作后端），则此功能十分有用。 这是因为，Azure 应用服务是使用共享空间和单个 IP 地址的多租户环境，只能使用自定义域设置中配置的主机名访问应用服务。 默认情况下，该主机名为“example.chinacloudsites.cn”。若要使用未注册到应用服务中的主机名或者使用应用程序网关的 FQDN 通过应用程序网关访问应用服务，则必须将原始请求中的主机名替代为应用服务的主机名。

### <a name="host-override"></a>**主机替代**

此功能可将应用程序网关上的传入请求中的 *host* 标头替换为此处指定的主机名。 

创建 HTTP 设置后，需将其关联到一个或多个请求路由规则。

## <a name="backend-pool"></a>后端池

后端池用于将请求路由到为请求提供服务的后端服务器。 后端池可以包含 NIC、虚拟机规模集、公共 IP、内部 IP、完全限定的域名 (FQDN) 和多租户后端（例如 Azure 应用服务）。 应用程序网关后端池成员不会绑定到可用性集。 后端池的成员可以跨群集、数据中心，或者在 Azure 外部，前提是它们建立了 IP 连接。 可为不同类型的请求创建不同的后端池。 例如，为常规请求创建一个后端池，为发往应用程序微服务的请求创建另一个后端池。

创建后端池后，需将其关联到一个或多个请求路由规则。 此外，需要为应用程序网关上的每个后端池配置运行状况探测。 满足请求路由规则条件时，应用程序网关会将流量转发到相应后端池中正常运行的服务器（是否正常由运行状况探测决定）。

## <a name="health-probes"></a>运行状况探测

默认情况下，Azure 应用程序网关会监视其后端池中所有资源的运行状况，并自动从池中删除任何被视为不正常的资源。 应用程序网关持续监视不正常的实例，一旦这些实例恢复可用状态并能响应运行状况探测，应用程序网关就会将它们添加回到正常的后端池中。 应用程序网关发送的运行状况探测所针对的端口与后端 HTTP 设置中定义的端口相同。

除了使用默认的运行状况探测监视以外，还可以根据应用程序的要求自定义运行状况探测。 使用自定义探测可以更精细地控制运行状况监视。 使用自定义探测时，可以配置探测间隔、要测试的 URL 和路径，以及在将后端池实例标记为不正常之前可接受的失败响应次数。 强烈建议配置自定义探测来监视每个后端池的运行状况。 有关详细信息，请参阅[监视应用程序网关的运行状况](/application-gateway/application-gateway-probe-overview)

## <a name="next-steps"></a>后续步骤

了解应用程序网关组件后，[可以在 Azure 门户中创建应用程序网关](quick-create-portal.md)、[使用 PowerShell 创建应用程序网关](quick-create-powershell.md)或[使用 Azure CLI 创建应用程序网关](quick-create-cli.md)。

